/*

 Template Builder v 2.5
 (2.5.0 - by revaxarts)

 Copyright (c) 2011 Xaver Birsak
 http://rxa.li/themeforest

 Licensed under the Envato Pty Ltd License Terms:
 http://themeforest.net/wiki/support/legal-terms/licensing-terms/

 limited, non-exclusive, non-transferable, non-sublicensable license
*/
$(document).ready(function(){var S=function(m){function M(){var a=location.pathname.split("/");a.pop();a.pop();k=location.protocol+"//"+location.host+a.join("/")+"/version"+b.version+"/img/"}function x(a){b.elements=$.map(h.find("img"),function(a){return $(a).attr("alt")});b.preheader=C.val();b.inline=u.is(":checked");b.absoluteurls=j.is(":checked");b.imagepath=y.val();b.color=D.val();b.service?(b.apikey=$("#"+b.service+"_apikey").val(),b.templatename=$("#"+b.service+"_templatename").val()):b.apikey=
b.templatename=null;b.useeditor="cm"==b.service?$("#cm_useeditor").is(":checked"):null;N.is(":checked")&&(savestring=b.serialize());a&&"object"==typeof JSON&&(a=b,delete a.elements,localStorage.setItem(location.pathname+"settings",JSON.stringify(a)),e("settings saved!"));var c="";$.each(b,function(a,b){switch(a){case "elements":(b=b.length)||(b='<span style="color:#f00;">no elements defined!</span>');break;case "clientid":b=$("option[value="+b+"]").html();a="client";break;case "service":b="cm"==b?
"Campaign Monitor":"mc"==b?"Mailchimp":"None";break;case "color":b='<span style="background-color:#'+b+'">&nbsp;</span>'+b}null!==b&&(c+="<dt>"+a+"</dt><dd>"+b+"</dd>")});$("#summery").html(c)}function v(){h.find("li").length?h.addClass("items"):h.removeClass("items")}function E(){if("object"===typeof prebuilds){z.html("");var a=F(),c="";$.isEmptyObject(a)||(c+='<h3>Custom</h3><ul class="prebuilds">',$.each(a,function(a){c+='<li><a name="'+a+'" class="prebuild">'+a+'</a><a class="delete">&times;</a></li>'}),
c+="</ul>");c+='<h3>Prebuilds</h3><ul class="prebuilds">';$.each(prebuilds,function(a){c+='<li><a name="'+a+'" class="prebuild">'+a+"</a></li>"});c+='</ul><ul id="preview"></ul>';z.html(c);G=$.extend({},prebuilds,a);w=$("#preview")}else throw"no prebuilds set";}function H(a){$('<li><a class="delete" title="delete">&times;</a><img src="../_img/types/'+a+'.gif" width="98" alt="'+a+'" title="'+elements[a]+'"></li>').hide().appendTo(h).slideDown()}function A(a,c){if(r!=a)$("section").eq(r).fadeOut(200,
function(){$("section").eq(a).fadeIn(200,function(){x();switch(a){case 2:I()}$.isFunction(c)&&c()})});else{$("section").eq(a).fadeIn();x();switch(a){case 2:I()}$.isFunction(c)&&c()}$("nav").find("a").removeClass("active").eq(a).addClass("active");$("#progress").animate({width:0==a?75:1==a?195:315},300*Math.abs(r-a));r=a}function I(a){if(g())return!1;g(!0);a=a||"../version"+b.version+"/all"+(b.inline?"_inline":"")+(b.service?"_"+b.service:"")+".html";l.val("loading HTML...");$.ajax({url:a,success:function(a){if("cm"==
b.service&&b.useeditor){for(var d=[],f=b.elements.length-1;0<=f;f--){var h=b.elements[f];-1===$.inArray(h,d)&&d.unshift(h)}b.elements=d}a=(new X(a)).get(b.absoluteurls,b.useeditor);l.val(a);g(!1);e("HTML loaded!",!0);s=0},error:function(){g(!1);3>s?(!s?e("couldn't load HTML ... load example",!1):e("couldn't load HTML ... load example (attempt "+(s+1)+")",!1),s++,setTimeout(function(){I("proxy.php?method=examplehtml&color="+b.color)},1E3)):(alert("Unable to generate HTML!\nPlease make sure you've uploaded all files correctly!"),
s=0)},dataType:"html"})}function g(a){if("undefined"==typeof a)return!!J;a?J++:J--;g()?O.addClass("busy"):O.removeClass("busy")}function e(a,c){$("<div>",{"class":"msg"}).addClass(!0===c?"success":!1===c?"error":"").hide().html(a).prependTo(Y).slideDown().delay(!1===c?9E3:5E3).fadeOut(function(){$(this).remove()})}function K(){h.find("li").slideUp(function(){$(this).remove()})}function Z(a,c){var b="undefined"!=typeof window.screenX?window.screenX:window.screenLeft,f="undefined"!=typeof window.screenY?
window.screenY:window.screenTop,g="undefined"!=typeof window.outerHeight?window.outerHeight:document.documentElement.clientHeight-22,b=parseInt((0>b?window.screen.width+b:b)+(("undefined"!=typeof window.outerWidth?window.outerWidth:document.documentElement.clientWidth)-a)/2,10),f=parseInt(f+(g-c)/2.5,10);return"width="+a+",height="+c+",left="+b+",top="+f+",scrollbars=1"}function t(a,c,b,f){$.post("proxy.php",$.extend(c,{method:a}),function(a){$.isFunction(b)&&b(a);!a.success&&$.isFunction(f)&&f(a);
e(a.response,a.success)},"json")}function P(a){a=$.map(a,function(a,b){return b+":"+a.join(",")});Q("CustomLayouts",a.join("|"))}function F(){var a=R("CustomLayouts");if(a){for(var a=a.split("|"),c={},b,f=a.length-1;0<=f;f--)b=a[f].split(":"),c[b[0]]=b[1].split(",");return c}return{}}function Q(a,c,b){var f=new Date,f=new Date(f.getTime()+(b||31536E6));document.cookie=a+"="+c+"; expires="+f.toGMTString()+"; "}function R(a){for(var c=document.cookie.split(";"),b,f=0;f<c.length;f++)if(b=c[f].substring(c[f].search("=")+
1),a==$.trim(c[f].substring(0,c[f].search("="))))return b;return!1}if(this===window)return new S(m);var r=0,s=0,k,G,J=0,b={version:1,color:null,elements:[],service:null,apikey:null,clientid:null,templatename:null,inline:!0,imagepath:null,absoluteurls:!0,useeditor:!1},w,l=$("#output"),Y=$("#status"),O=$("#content"),h=$("#dropzone"),z=$("#prebuilds"),B=$("#versions"),L=$("#services"),N=$("#savesettings"),u=$("#inlinecss"),C=$("#preheader"),j=$("#absoluteurls"),y=$("#domain"),D=$("#customcolor"),X=function(a){var c,
d;return{get:function(f,g){var e;e="";c=RegExp("([^\u263a]+)[^>]+ --\x3e","gi");d=c.exec(a);e+=d?d[0]+"\n":"";var h="";$.each(b.elements,function(b,f){var e=h;c=RegExp("(\x3c!-- [^\u263a]+)\u263a"+f+"\u263a --\x3e([^\u263a]+)\u263a"+f+"\u263a([^<]+)","g");d=c.exec(a);h=e+(d?d[1]+" --\x3e"+d[2]+" "+d[3]:"")});e+=h;c=RegExp("\x3c!-- Footer start --\x3e([^\u263a]+)","gi");d=c.exec(a);d=(e+=d?"\x3c!-- Footer start --\x3e"+d[1]:"")||a;f&&(d=d.replace(/src="img\//g,'src="'+k).replace(/background="img\//g,
'background="'+k).replace(/url\('img\//g,"url('"+k));d=d.replace("\x3c!-- PREHEADER --\x3e",C.val()||"");switch(b.service){case "mc":e=/mc:edit="([^"]+)"/gi;for(var j={};result=e.exec(d);)j[result[1]]?d=d.replace(result[0],'mc:edit="'+result[1]+" ("+j[result[1]]++ +')"'):(j[result[1]]=1,d=d.replace(result[0],'mc:edit="'+result[1]+'%%%%"'));d=d.replace(/%%%%"/g,'"');break;case "cm":e=/label="([^"]+)"/gi;for(j={};result=e.exec(d);)j[result[1]]?d=d.replace(result[0],'label="'+result[1]+" ("+j[result[1]]++ +
')"'):(j[result[1]]=1,d=d.replace(result[0],'label="'+result[1]+'%%%%"'));d=d.replace(/%%%%"/g,'"');!1===g&&(d=d.replace(/<\/?repeater>/gi,"").replace(/<\/?layout([^>]*)>/gi,""))}return d=d.replace(RegExp("#"+colors[b.version-1],"g"),"#"+b.color)}}};m=R("lastservercheck");var T=(new Date).getTime(),U;180<=(T-m)/6E4&&(U=setTimeout(function(){confirm("No response from the server! Would you like to check the configuration?")?location.href="proxy.php":alert("The Template Builder may not work as expected with your current server configuration!")},
5E3),e("checking server configuration..."),t("check",null,function(a){if(null===a)return!1;clearTimeout(U);Q("lastservercheck",T);(!a||!a.success)&&setTimeout(function(){confirm("It seems your server needs an update:\n\n"+a.response.replace(/<br>/g,"\n")+"\nWould you like to check the configuration?")?location.href="proxy.php":alert("The Template Builder may not work as expected with your current server configuration!")},1E3)}));E();if("object"===typeof elements){var V=0,W=0;$.each(elements,function(){V++});
var n="<ul>";$.each(elements,function(a,b){W++;n+='<li><img src="../_img/types/'+a+'.gif" width="98" alt="'+a+'" title="'+b+'"></li>';parseInt(W%(V/4),10)||(n+="</ul><ul>")});n+="</ul>";$("#elements").html(n).find("img").css({opacity:0.8})}else throw"no elements set";$("#elements ul li").draggable({connectToSortable:h,containment:"#content",helper:"clone",revert:"invalid",zIndex:1E3});h.sortable({stop:function(a,b){b.offset.left>h.offset().left+110&&b.item.find("a.delete").click()},receive:function(){h.find("li").each(function(){var a=
$(this);a.has("a").length||(a.find("img").css("opacity",1),$('<a class="delete" title="delete">&times;</a>').prependTo(a))});v()},containment:"#rec",revert:!0,distance:10,revertDuration:1});if("object"===typeof colors){m="<ul>";for(var aa=colors.length,p=0;p<aa;p++)m+='<li style="background-color:#'+bgcolors[p]+'"><a title="color #'+colors[p]+'" style="background-color:#'+colors[p]+'" data-color="#'+colors[p]+'" data-version="'+(p+1)+'"></a></li>';B.html(m+"</ul>")}else throw"no prebuilds set";$("body").delegate("a[href^='http']",
"click",function(){window.open($(this).attr("href"));return!1});$("nav").delegate("a","click",function(){var a=$(this);A(a.data("id"),function(){});return!1});$(".next").bind("click",function(){A(r+1)});$(".prev").bind("click",function(){A(r-1)});z.delegate("a.delete","click",function(){var a=$(this),b=a.prev().attr("name"),d=F();delete d[b];P(d);a.parent().slideUp(function(){E()})}).delegate("a.prebuild","click",function(){K();$.each(G[this.name],function(a,b){H(b)});v()}).delegate("a.prebuild",
"mouseenter",function(){var a="";$.each(G[this.name],function(b,d){a+='<li><img src="../_img/types/'+d+'.gif" width="98" alt="'+d+'" title="'+name+'"></li>'});w.css({left:z.position().left+200});w.html(a).stop().fadeTo(100,1)}).delegate("a.prebuild","mouseleave",function(){w.stop().fadeOut(100)}).bind("mousemove",function(a){w.css({top:a.pageY-120})});$("#elements").find("img").bind({click:function(){H(this.alt);v();e('added module "'+elements[this.alt]+'"')},mouseover:function(){$(this).stop().fadeTo(100,
1)},mouseout:function(){$(this).stop().fadeTo(100,0.8)}});$("#cleardz").bind("click",function(){K();h.removeClass("items")});$("#savelayout").bind("click",function(){x();if(!b.elements.length)return e("Please bring some elements in the dropzone!"),!1;if(name=prompt("Save your layout for later!\nYou have to define a name. If the name already exists it will get overwritten")){var a=name,c=b.elements,d=F();d[a]=c;P(d);E()}});$("#addAll").bind("click",function(){K();$.each($("#elements").find("img"),
function(){H(this.alt)});v()});h.delegate("a.delete","click",function(){$(this).parent().slideUp(function(){$(this).remove();v()})});B.delegate("li","click",function(){var a=$(this).find("a");b.version=a.data("version");b.color=a.data("color");D.val(b.color.substr(1)).css("background-color",b.color).trigger("change");B.find(".active").removeClass("active");$(this).addClass("active");M();j.trigger("change")});L.delegate("a[data-role]","click",function(){var a=$(this);if(!a.data("role")||a.next().is(":hidden"))L.find(".active").removeClass("active"),
L.find(".service").slideUp();b.service=a.data("role");a.next().slideDown().find("input").eq(0).focus();switch(a.data("role")){case "mc":$("#cm_upload").hide();u.prop("checked",!1).prop("disabled",!0);j.prop("checked",!0).prop("disabled",!0).trigger("change");break;case "cm":$("#mc_upload").hide();u.prop("checked",!1).prop("disabled",!0);j.prop("checked",!0).prop("disabled",!0).trigger("change");break;default:j.prop("disabled",!1),u.prop("disabled",!1),$("#cm_upload").hide(),$("#mc_upload").hide()}a.addClass("active")}).delegate("#mc_apikey",
"change",function(){var a=$(this),c={apikey:a.eq(0).val()};if(g()||!c.apikey)return!1;g(!0);a.removeClass("error success").addClass("loading");e("verifying api key...");t("ping_mc",c,function(d){a.removeClass("loading error success").addClass(d.success?"success":"error");g(!1);b.clientid=null;d.success?($("#mc_upload").show(),b.apikey=c.apikey):($("#mc_upload").hide(),b.apikey=null)})}).delegate("#cm_apikey","change",function(){var a=$(this),c={apikey:a.eq(0).val()};if(g()||!c.apikey)return!1;g(!0);
a.removeClass("error success").addClass("loading");e("verifying credentials...");t("ping_cm",c,function(d){a.removeClass("loading error success").addClass(d.success?"success":"error");g(!1);d.success?(clients=$.map(d.clients,function(a){return'<option value="'+a.ClientID+'"'+(b.clientid==a.ClientID?" selected":"")+">"+a.Name+"</option>"}),$("#cm_clientid").prop("disabled",!1).html(clients.join("")),b.clientid||$("#cm_clientid").find("option").eq(0).attr("selected","selected"),b.clientid=$("#cm_clientid").find("option:selected").val(),
b.apikey=c.apikey,$("#cm_upload").show()):($("#cm_upload").hide(),b.clientid=null,b.apikey=null)})}).delegate("#cm_clientid","change",function(){b.clientid=$(this).val()}).delegate("a.btn","click",function(){$(this).parent().parent().find(".input").eq(0).trigger("change")});j.bind("change",function(){j.is(":checked")?y.val(k):y.val("")});N.bind("click",function(){x(!0)});$("#clearsettings").bind("click",function(){e("clear settings...");localStorage.removeItem(location.pathname+"settings");e("cleared!")});
$("#previewbtn").bind("click",function(){var a=window.open("about:blank","preview",Z(640,900));a.document.body.innerHTML='<span style="font-family:sans-serif">please wait...</span>';setTimeout(function(){var b=l.val(),b=b.replace(/src="img\//g,'src="'+k).replace(/background="img\//g,'background="'+k).replace(/url\('img\//g,"url('"+k);/@media /.test(b)&&(b=b.replace(/@media only screen and \(max-device-width: ?480/g,"@media only screen and (max-width: 599").replace(/@media only screen and \(max-device-width: ?320/g,
"@media only screen and (max-width: 479"));a.document.body.innerHTML=b;$.browser.msie&&a.document.write(b)},500);return!1});$("#downloadbtn").bind("click",function(){if(g())return!1;g(!0);e("prepare download...");var a=l.val();t("download",{data:a},function(a){g(!1);a.success&&window.open("proxy.php?download="+a.file)})});$("#mc_upload").bind("click",function(){if(g())return!1;if(!b.elements.length)return $("#step1").click(),e("You have to select at least one module!",!1),!1;g(!0);e("upload to Mailchimp...");
var a={apikey:b.apikey,templatename:b.templatename,data:l.val()};t("upload_mc",a,function(){g(!1)})});$("#cm_upload").bind("click",function(){if(g())return!1;if(!b.elements.length)return $("#step1").click(),e("You have to select at least one module!",!1),!1;g(!0);e("upload to Campaign Monitor...");var a={apikey:b.apikey,templatename:b.templatename,clientid:b.clientid,data:l.val()};t("upload_cm",a,function(){g(!1)})});$("#selectHTML").bind("click",function(){l.select().focus();setTimeout(function(){l[0].scrollTop=
0},1)});M();B.find("a[data-version="+b.version+"]").parent().click();A(0);var q=localStorage.getItem(location.pathname+"settings");q&&(q=$.parseJSON(q),$.each(q,function(a,b){switch(a){case "version":$("#versions").find("li").eq(b-1).click();break;case "color":D.val(b);break;case "service":$("a[data-role="+b+"]").click();break;case "apikey":switch(q.service){case "mc":$("#mc_apikey").val(b).trigger("change");break;case "cm":$("#cm_apikey").val(b).trigger("change")}break;case "inline":u.prop("checked",
b);break;case "imagepath":y.val(b);break;case "preheader":C.val(b);break;case "absoluteurls":j.prop("checked",b);break;case "useeditor":$("#cm_useeditor").prop("checked",b);break;case "templatename":switch(q.service){case "mc":$("#mc_templatename").val(b);break;case "cm":$("#cm_templatename").val(b)}}}),e("settings loaded"),b=q);$("[title]").tipsy({gravity:"s",opacity:1})};S()});
